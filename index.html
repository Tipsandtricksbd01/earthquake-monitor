<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Seismic Monitor & Tectonic Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: calc(100vh - 80px); width: 100%; z-index: 1; }
        .legend {
            background: white;
            padding: 10px;
            line-height: 1.5em;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; border-radius: 50%; }
        .plate-line { font-weight: bold; margin-bottom: 5px; display: block; }
    </style>
</head>
<body class="bg-slate-900 text-white overflow-hidden">

    <!-- Header -->
    <header class="h-20 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-6 shadow-lg relative z-10">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span class="text-red-500 animate-pulse">‚óè</span> 
                Earthquake Monitor & Tectonic Map
            </h1>
            <p id="status" class="text-xs text-slate-400">Syncing with USGS live feed...</p>
        </div>
        <div class="flex gap-4 text-sm">
            <div class="bg-slate-700 px-3 py-1 rounded border border-slate-600">
                <span id="quake-count">0</span> Earthquakes (Last 24h)
            </div>
            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-500 px-4 py-1 rounded transition">Refresh Now</button>
        </div>
    </header>

    <div id="map"></div>

    <script>
        // Global variables
        let map;
        let earthquakeLayer = L.layerGroup();
        let plateLayer = L.geoJSON();

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([20, 0], 2.5);

            // Dark Mode Tile Layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            earthquakeLayer.addTo(map);
            
            // Add Legend
            addLegend();
            
            // Initial Data Load
            fetchData();
            loadPlateBoundaries();
        }

        // Fetch Live Earthquake Data from USGS
        async function fetchData() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "Refreshing seismic data...";
            
            try {
                // USGS GeoJSON Summary Feed (Past Day, Magnitude 1.0+)
                const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/1.0_day.geojson');
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                updateEarthquakes(data.features);
                document.getElementById('quake-count').innerText = data.metadata.count;
                statusEl.innerText = `Auto-updating every 1 min. Last sync: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error("Error fetching data:", error);
                statusEl.innerText = "Connection error. Retrying in 60s...";
            }
        }

        // Load Tectonic Plate Boundaries
        async function loadPlateBoundaries() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_boundaries.json');
                const data = await response.json();
                
                L.geoJSON(data, {
                    style: function(feature) {
                        return {
                            color: "#ffae00",
                            weight: 2,
                            opacity: 0.6,
                            dashArray: '5, 5'
                        };
                    }
                }).addTo(map);
            } catch (e) {
                console.error("Could not load plate boundaries", e);
            }
        }

        function updateEarthquakes(features) {
            earthquakeLayer.clearLayers();
            
            features.forEach(quake => {
                const coords = [quake.geometry.coordinates[1], quake.geometry.coordinates[0]];
                const mag = quake.properties.mag;
                const place = quake.properties.place;
                const time = new Date(quake.properties.time).toLocaleString();
                const depth = quake.geometry.coordinates[2];
                const url = quake.properties.url;

                const circle = L.circleMarker(coords, {
                    radius: getRadius(mag),
                    fillColor: getColor(mag),
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                circle.bindPopup(`
                    <div class="text-slate-900">
                        <h3 class="font-bold border-b mb-1">Magnitude ${mag}</h3>
                        <p class="text-sm"><b>Location:</b> ${place}</p>
                        <p class="text-sm"><b>Time:</b> ${time}</p>
                        <p class="text-sm"><b>Depth:</b> ${depth} km</p>
                        <a href="${url}" target="_blank" class="text-blue-600 text-xs underline mt-2 block">Full USGS Report</a>
                    </div>
                `);

                earthquakeLayer.addLayer(circle);
            });
        }

        function getColor(mag) {
            return mag > 6 ? '#ff0000' :
                   mag > 5 ? '#ff6600' :
                   mag > 4 ? '#ff9900' :
                   mag > 3 ? '#ffcc00' :
                   mag > 2 ? '#ffff00' :
                             '#99ff33';
        }

        function getRadius(mag) {
            if (mag <= 0) return 2;
            return mag * 4;
        }

        function addLegend() {
            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend text-slate-800');
                const grades = [0, 2, 3, 4, 5, 6];
                
                div.innerHTML = '<div class="font-bold mb-2">Magnitude</div>';

                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                }
                
                div.innerHTML += '<hr class="my-2"><span class="plate-line" style="color:#ffae00">--- Tectonic Plate Boundary</span>';
                return div;
            };
            legend.addTo(map);
        }

        window.onload = initMap;

        // Auto-refresh every 1 minute (60,000 milliseconds)
        setInterval(fetchData, 60000);

    </script>
</body>
</html>